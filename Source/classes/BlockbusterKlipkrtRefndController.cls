public class BlockbusterKlipkrtRefndController {
    

    public static final Aria_Error_Code__c ArCode = Aria_Error_Code__c.getInstance('2020');
    public transient HttpResponse res;
     
     // Get lasst faktura from Invoice payment
     public static list<Invoice_Payment__c> lastFaktura(Id AccountID)
     {
        List<Invoice_Payment__c> listInvPay = new List<Invoice_Payment__c>();
        listInvPay = [select Account__c,Aria_Account__r.name,Account__r.Customer_No__c,Amount_Applied__c,Aria_Account__c,Aria_Account__r.Aria_Account_No__c,Balance__c,Betalingsfrist__c,checkPaymentApplied__c,
                     CreatedById,CreatedDate,Datoforudskrift__c,External_Name__c,Faktura__r.Datoforudskrift__c,Fakturabelob__c,Fakturanummer__c,Faktura__r.name,
                      Faktura__c,Faktura__r.Aria_Account__r.Name,Id,invoice_no__c,Invoice_Statement__c,Invoice_Type__c,IsDeleted,isVoid__c,
                      LastModifiedById,LastModifiedDate,Momspligtigt_bel_b__c,Name,Payment_date_time__c,Payment_date__c,
                      Payment__c,Refund_BB__c,Refund_button__c,Refund__c,Remaining_coupons__c,Saldo__c,Service_Credit__c,
                      sort__c,statement_no__c,SystemModstamp,Titel__c,Transaction_Date__c,Transaction_No__c,Void_Date__c 
                      FROM Invoice_Payment__c 
                      WHERE Faktura__r.HasKlips__c != 0.0 and Refund_BB__c = null and Account__c =: AccountID and Refund_BB__c = null order by CreatedDate desc limit 1];
        return listInvPay;
     } 
     
    public static List<Invoice_Subscription__c> PageLoadFun(Id AccountID,String selectComments,List<Invoice_Payment__c> listInvPay)
    {
        list<Invoice_Subscription__c > listAllKlipikort = new list<Invoice_Subscription__c >();
        listAllKlipikort = [SELECT Amount__c,Comments__c,CreatedDate,Faktura_line_no__c,Faktura__c,Faktura__r.name,Faktura__r.Aria_Account__r.Name,
                            Invoice_Number__c,IsDeleted,Name,Periode__c,Plan_Name__c,Pris_pr_md__c,Service_Name__c,id
                            FROM Invoice_Subscription__c 
                            where Faktura__c =: listInvPay[0].Faktura__c order by Name asc];
       //listAllKlipikort.sort();                   
       return listAllKlipikort;
    }
    
    public static string klipRefund(List<Invoice_Subscription__c> listAllKlipikort, List<Invoice_Payment__c> listInvPay,Id AccountID,String selectComments,HttpResponse Refundres,Decimal amount,string includeused)
    {
        BlockBusterIssueRefundWrapper objBBIssueRef;
        BlockBusterRefundDetailsWrapper objBBRefundDetails;
        transient HttpResponse canclKlips;
        List<BlockBusterCancelKlips> listCanclklip;
        boolean KlippiPrsnt;
        boolean errBlock;
        string errMsg = '';  
        Account acc = [select Betaler_ID__c,Betaler__c,Customer_No__c,Email__c,PersonEmail,FirstName,LastName from Account where id =: AccountID];
        
        // Callout - Get klippikort status
        transient HttpResponse res = BlockBusterODPServices.getKlipsStatus(acc.Customer_No__c); 
        List<BlockBusterKlipStatus> BBKlipStatus = new List<BlockBusterKlipStatus>();
        string resBody = res.getbody();
        system.debug('Klip status ******* RES '+resBody);
        if(Test.isRunningTest() == true)
        {
            //resBody = '{"clipcards":[{"ref":"7d4d8e4ad9cfaa759b8225b6c03ad4b4","product_id":"1","price":"9900","created_at":"2014-11-10 05:11:23","title":"Klippekort","num_clip":"3","clips":[{"id":"268","expires_at":"2015-11-10 05:11:23","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"269","expires_at":"2015-11-10 05:11:23","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"270","expires_at":"2015-11-10 05:11:23","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"97c5e41ed3c91375912cbce05c47718d","product_id":"1","price":"9900","created_at":"2014-11-10 05:11:48","title":"Klippekort","num_clip":"3","clips":[{"id":"271","expires_at":"2015-11-10 05:11:48","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"272","expires_at":"2015-11-10 05:11:48","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"273","expires_at":"2015-11-10 05:11:48","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"93db07a2ee07942dc916685bddeac3a4","product_id":"1","price":"9900","created_at":"2014-11-10 05:12:16","title":"Klippekort","num_clip":"3","clips":[{"id":"274","expires_at":"2015-11-10 05:12:16","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"275","expires_at":"2015-11-10 05:12:16","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"276","expires_at":"2015-11-10 05:12:16","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"bac050dde7a5666b88d801d1a22378e1","product_id":"1","price":"9900","created_at":"2014-11-12 06:54:26","title":"Klippekort","num_clip":"3","clips":[{"id":"412","expires_at":"2015-11-12 06:54:26","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"413","expires_at":"2015-11-12 06:54:26","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"414","expires_at":"2015-11-12 06:54:26","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"d13a11881289d904c68b5cc7cb7e7094","product_id":"1","price":"9900","created_at":"2014-11-12 06:54:38","title":"Klippekort","num_clip":"3","clips":[{"id":"415","expires_at":"2015-11-12 06:54:38","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"416","expires_at":"2015-11-12 06:54:38","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"417","expires_at":"2015-11-12 06:54:38","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"03618b24a49e81f95f3d3dfddaed1502","product_id":"1","price":"9900","created_at":"2014-11-12 06:54:52","title":"Klippekort","num_clip":"3","clips":[{"id":"418","expires_at":"2015-11-12 06:54:52","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"419","expires_at":"2015-11-12 06:54:52","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"420","expires_at":"2015-11-12 06:54:52","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"88300c4bf21e9fd0a29d2edc076db5de","product_id":"1","price":"9900","created_at":"2014-11-12 06:55:08","title":"Klippekort","num_clip":"3","clips":[{"id":"421","expires_at":"2015-11-12 06:55:08","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"422","expires_at":"2015-11-12 06:55:08","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"423","expires_at":"2015-11-12 06:55:08","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"9b1bc64e8c37a7f58e65e557539156aa","product_id":"1","price":"9900","created_at":"2014-11-12 06:55:30","title":"Klippekort","num_clip":"3","clips":[{"id":"424","expires_at":"2015-11-12 06:55:30","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"425","expires_at":"2015-11-12 06:55:30","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"426","expires_at":"2015-11-12 06:55:30","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"008512ad1b9af4adff3d73f68ad9a1b9","product_id":"1","price":"9900","created_at":"2014-11-12 06:55:48","title":"Klippekort","num_clip":"3","clips":[{"id":"427","expires_at":"2015-11-12 06:55:48","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"428","expires_at":"2015-11-12 06:55:48","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"429","expires_at":"2015-11-12 06:55:48","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"89bb7bc0267bcf75d97acfb1c0d98538","product_id":"1","price":"9900","created_at":"2014-11-12 06:56:05","title":"Klippekort","num_clip":"3","clips":[{"id":"430","expires_at":"2015-11-12 06:56:05","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"431","expires_at":"2015-11-12 06:56:05","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"432","expires_at":"2015-11-12 06:56:05","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"2f4a5574747045512bc9fc8ff8c1a13f","product_id":"1","price":"9900","created_at":"2014-11-12 06:58:41","title":"Klippekort","num_clip":"3","clips":[{"id":"433","expires_at":"2015-11-12 06:58:41","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"434","expires_at":"2015-11-12 06:58:41","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"435","expires_at":"2015-11-12 06:58:41","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"dfe6d5160494e0a2908b218e855e6846","product_id":"1","price":"9900","created_at":"2014-11-12 07:13:01","title":"Klippekort","num_clip":"3","clips":[{"id":"436","expires_at":"2015-11-12 07:13:01","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"437","expires_at":"2015-11-12 07:13:01","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"438","expires_at":"2015-11-12 07:13:01","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"ed62821972fcee2a6ca6b051d103107d","product_id":"1","price":"9900","created_at":"2014-11-12 07:13:27","title":"Klippekort","num_clip":"3","clips":[{"id":"439","expires_at":"2015-11-12 07:13:27","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"440","expires_at":"2015-11-12 07:13:27","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"441","expires_at":"2015-11-12 07:13:27","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"2d5da5c4bce390c8c7f1f943e2204a52","product_id":"1","price":"9900","created_at":"2014-11-12 07:15:57","title":"Klippekort","num_clip":"3","clips":[{"id":"442","expires_at":"2015-11-12 07:15:57","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"443","expires_at":"2015-11-12 07:15:57","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"444","expires_at":"2015-11-12 07:15:57","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"2fd6db31fac45ee7553696fbd59f8cf3","product_id":"1","price":"9900","created_at":"2014-11-12 07:16:17","title":"Klippekort","num_clip":"3","clips":[{"id":"445","expires_at":"2015-11-12 07:16:17","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"446","expires_at":"2015-11-12 07:16:17","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"447","expires_at":"2015-11-12 07:16:17","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"97229e0eeb4d8e30e61e1ed64312524e","product_id":"1","price":"9900","created_at":"2014-11-12 07:16:36","title":"Klippekort","num_clip":"3","clips":[{"id":"448","expires_at":"2015-11-12 07:16:36","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"449","expires_at":"2015-11-12 07:16:36","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"450","expires_at":"2015-11-12 07:16:36","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"aab474fe0dc79c8c5466edd4753aad1b","product_id":"1","price":"9900","created_at":"2014-11-12 07:18:24","title":"Klippekort","num_clip":"3","clips":[{"id":"451","expires_at":"2015-11-12 07:18:24","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"452","expires_at":"2015-11-12 07:18:24","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"453","expires_at":"2015-11-12 07:18:24","updated_at":null,"state":"free","price":null,"order_type":null}]},{"ref":"1e1108b3267203f3ae6cf9801e6c2b21","product_id":"1","price":"9900","created_at":"2014-11-12 07:18:44","title":"Klippekort","num_clip":"3","clips":[{"id":"454","expires_at":"2015-11-12 07:18:44","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"455","expires_at":"2015-11-12 07:18:44","updated_at":null,"state":"free","price":null,"order_type":null},{"id":"456","expires_at":"2015-11-12 07:18:44","updated_at":null,"state":"free","price":null,"order_type":null}]}]}';
        	resBody = '{"clipcards":[{"ref":"7736ba4b25c5c0bc270fbd94fc88a931","product_id":"1","price":"9900","koda":244,"created_at":"2015-01-30 12:54:26","title":"Klippekort","num_clip":"3","clips":[{"id":"1225","expires_at":"2016-01-30 12:54:26","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1226","expires_at":"2016-01-30 12:54:26","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1227","expires_at":"2016-01-30 12:54:26","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null}]},{"ref":"acf54af4c41de4e775f52e0237208535","product_id":"1","price":"9900","koda":244,"created_at":"2015-01-30 12:54:50","title":"Klippekort","num_clip":"3","clips":[{"id":"1228","expires_at":"2016-01-30 12:54:50","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1229","expires_at":"2016-01-30 12:54:50","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1230","expires_at":"2016-01-30 12:54:50","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null}]},{"ref":"5caee54bcff133914d5ea5f7547490c4","product_id":"1","price":"9900","koda":244,"created_at":"2015-01-30 12:55:15","title":"Klippekort","num_clip":"3","clips":[{"id":"1231","expires_at":"2016-01-30 12:55:15","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1232","expires_at":"2016-01-30 12:55:15","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null},{"id":"1233","expires_at":"2016-01-30 12:55:15","updated_at":null,"state":"free","price":null,"price_koda":3300,"koda":81,"order_type":null}]}]}';
        }
        BBKlipStatus = BlockbusterParse.parseKlipsStatus(resBody);
        
        String issueRefund;
        string refundDetails;
        
        // Callout - send invoice details to issue refund
        if(!Test.isRunningTest())
            issueRefund = Refundres.getBody();
        if(test.isRunningTest() == true)
        {
            issueRefund = '{"reversed_invoice_lines":[{"invoice_no":61266989,"invoice_line_no":1,"invoice_line_service_no":11163622,"invoice_line_reversed_amount":79.2,"invoice_line_reversing_date":null,"invoice_line_comments":"Blockbuster Klippekort (order # 5991870)","client_invoice_line_service_id":"Blockbuster_Klippekort"},{"invoice_no":61266989,"invoice_line_no":2,"invoice_line_service_no":10004,"invoice_line_reversed_amount":19.8,"invoice_line_reversing_date":null,"invoice_line_comments":"Value Added Tax (VAT)","client_invoice_line_service_id":"10004"}],"applied_total_refund_amount":99,"applied_total_reversal_amount":99,"transaction_id":"84305771","error_code":0,"error_msg":"OK"}';
        }
        if(BBKlipStatus.size() > 0)
        {
            if(issueRefund != '')
            {
                objBBIssueRef = new BlockBusterIssueRefundWrapper();
                objBBIssueRef = BlockbusterParse.parseIssueRefund(issueRefund);   
                if(objBBIssueRef!=null)
                {
                    if(objBBIssueRef.error_msg=='OK') 
                    {
                        // Callout - get Refund  details
                        transient HttpResponse respRefundDetails = BlockBusterCallOut.RefundDetails(String.valueOf(listInvPay[0].Aria_Account__r.Aria_Account_No__c));
                        if(!Test.isRunningTest())
                            refundDetails = respRefundDetails.getBody();
                        if(Test.isRunningTest() == true)
                        {
                            refundDetails = '{"error_code":0,"refund_details":[{"refund_transaction_id":"83705782","refund_amount":99,"create_date":"2014-11-09","create_user":"Taxes","reason_code":5,"reason_label":"Good Will","reason_description":"Good Will","ref_payment_transaction_id":8260266,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61130177,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61130177,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83706389","refund_amount":99,"create_date":"2014-11-09","create_user":"Taxes","reason_code":5,"reason_label":"Good Will","reason_description":"Good Will","ref_payment_transaction_id":83624847,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61130013,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61130013,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83706521","refund_amount":99,"create_date":"2014-11-09","create_user":"Taxes","reason_code":5,"reason_label":"Good Will","reason_description":"Good Will","ref_payment_transaction_id":83624868,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61130028,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61130028,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83818616","refund_amount":49,"create_date":"2014-11-11","create_user":"Taxes","reason_code":5,"reason_label":"Good Will","reason_description":"Good Will","ref_payment_transaction_id":83616316,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":49,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61127945,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":39.2,"reversed_line_amount":39.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61127945,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":9.8,"reversed_line_amount":9.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83847145","refund_amount":39,"create_date":"2014-11-11","create_user":"Taxes","reason_code":3,"reason_label":"Customer dissatisfaction","reason_description":"Customer dissatisfaction","ref_payment_transaction_id":83611303,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":39,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61126379,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":31.2,"reversed_line_amount":31.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61126379,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":7.8,"reversed_line_amount":7.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83850176","refund_amount":49,"create_date":"2014-11-11","create_user":"Taxes","reason_code":7,"reason_label":"Wrong undesired payment source charged","reason_description":"Wrong undesired payment source charged","ref_payment_transaction_id":83610212,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":49,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61126015,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":39.2,"reversed_line_amount":39.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61126015,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":9.8,"reversed_line_amount":9.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83852619","refund_amount":49,"create_date":"2014-11-11","create_user":"Taxes","reason_code":2,"reason_label":"Goods services not delivered","reason_description":"Goods services not delivered","ref_payment_transaction_id":83616340,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":49,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61127947,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":39.2,"reversed_line_amount":39.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61127947,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":9.8,"reversed_line_amount":9.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83881478","refund_amount":99,"create_date":"2014-11-12","create_user":"Taxes","reason_code":7,"reason_label":"Wrong undesired payment source charged","reason_description":"Wrong undesired payment source charged","ref_payment_transaction_id":83757506,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196510,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196510,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83882272","refund_amount":99,"create_date":"2014-11-12","create_user":"Taxes","reason_code":1,"reason_label":"Account charged in error","reason_description":"Account charged in error","ref_payment_transaction_id":83757499,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196507,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196507,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"83882466","refund_amount":99,"create_date":"2014-11-12","create_user":"Taxes","reason_code":4,"reason_label":"Cancellation of pre-paid service","reason_description":"Cancelation of pre-paid service","ref_payment_transaction_id":83757504,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196509,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196509,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84018353","refund_amount":49,"create_date":"2014-11-13","create_user":"Taxes","reason_code":1,"reason_label":"Account charged in error","reason_description":"Account charged in error","ref_payment_transaction_id":83616398,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":49,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61127951,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":39.2,"reversed_line_amount":39.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61127951,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":9.8,"reversed_line_amount":9.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84018688","refund_amount":69,"create_date":"2014-11-13","create_user":"Taxes","reason_code":3,"reason_label":"Customer dissatisfaction","reason_description":"Customer dissatisfaction","ref_payment_transaction_id":83616490,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":69,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61127955,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":55.2,"reversed_line_amount":55.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61127955,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":13.8,"reversed_line_amount":13.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84145197","refund_amount":99,"create_date":"2014-11-14","create_user":"Taxes","reason_code":2,"reason_label":"Goods services not delivered","reason_description":"Goods services not delivered","ref_payment_transaction_id":83757495,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196505,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196505,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84145361","refund_amount":99,"create_date":"2014-11-14","create_user":"Taxes","reason_code":4,"reason_label":"Cancellation of pre-paid service","reason_description":"Cancelation of pre-paid service","ref_payment_transaction_id":83757497,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196506,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196506,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84174737","refund_amount":29,"create_date":"2014-11-14","create_user":"Taxes","reason_code":1,"reason_label":"Account charged in error","reason_description":"Account charged in error","ref_payment_transaction_id":83617615,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":29,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61128061,"invoice_bill_date":"2014-11-07","invoice_line_no":1,"total_line_debit":23.2,"reversed_line_amount":23.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61128061,"invoice_bill_date":"2014-11-07","invoice_line_no":2,"total_line_debit":5.8,"reversed_line_amount":5.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84174757","refund_amount":99,"create_date":"2014-11-14","create_user":"Taxes","reason_code":2,"reason_label":"Goods services not delivered","reason_description":"Goods services not delivered","ref_payment_transaction_id":83757502,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61196508,"invoice_bill_date":"2014-11-10","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61196508,"invoice_bill_date":"2014-11-10","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84305742","refund_amount":99,"create_date":"2014-11-17","create_user":"Taxes","reason_code":5,"reason_label":"Good Will","reason_description":"Good Will","ref_payment_transaction_id":83882628,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":3,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61267033,"invoice_bill_date":"2014-11-12","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61267033,"invoice_bill_date":"2014-11-12","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]},{"refund_transaction_id":"84305771","refund_amount":99,"create_date":"2014-11-17","create_user":"Taxes","reason_code":7,"reason_label":"Wrong undesired payment source charged","reason_description":"Wrong undesired payment source charged","ref_payment_transaction_id":83882540,"ref_payment_transaction_type":3,"ref_payment_transaction_desc":"Electronic Payment","ref_payment_amount":99,"ref_payment_ref_code":null,"bill_seq_no":2,"pay_method_id":13,"pay_method_name":"Tokenized Credit Card","cc_id":null,"cc_type":null,"payment_src_suffix":null,"refund_check_num":null,"is_voided_ind":0,"invoice_reversals":[{"invoice_no":61266989,"invoice_bill_date":"2014-11-12","invoice_line_no":1,"total_line_debit":79.2,"reversed_line_amount":79.2,"reversed_line_start_date":null,"reversed_line_end_date":null},{"invoice_no":61266989,"invoice_bill_date":"2014-11-12","invoice_line_no":2,"total_line_debit":19.8,"reversed_line_amount":19.8,"reversed_line_start_date":null,"reversed_line_end_date":null}]}],"error_msg":"OK"}';
                        }
                        if(refundDetails != '')
                        {
                            objBBRefundDetails = new BlockBusterRefundDetailsWrapper();
                            objBBRefundDetails = BlockbusterParse.parseRefundDetails(refundDetails);
                            if(objBBRefundDetails != null)
                            {
                                if(objBBRefundDetails.error_msg=='OK')
                                {
                                    //Callout - Cancl klips call
                                    String cancelbody;
                                    if(!Test.isRunningTest())
                                    {
                                        System.debug('***listInvPay[0].Account__r.Customer_No__c***'+listInvPay[0].Account__r.Customer_No__c);
                                        canclKlips = BlockBusterODPServices.CancelKlips(listInvPay[0].Account__r.Customer_No__c,BBKlipStatus[BBKlipStatus.size()-1].ref,includeused);
                                        cancelbody = canclKlips.getBody();
                                        system.debug('cancl cklip res body ******* '+cancelbody);
                                    }
                                    
                                    if(Test.isRunningTest()) 
                                    {
                                    	//cancelbody = '{"refunds":[{"transaction_id":1436614,"billing_entry_id":"795","clip_id":"925","ref":"1006c5b6b1f0134b851d2dfa39f42cd3","refunded_clip_price":3300,"koda":81},{"transaction_id":1436615,"billing_entry_id":"795","clip_id":"926","ref":"1006c5b6b1f0134b851d2dfa39f42cd3","refunded_clip_price":3300,"koda":81},{"transaction_id":1436616,"billing_entry_id":"795","clip_id":"927","ref":"1006c5b6b1f0134b851d2dfa39f42cd3","refunded_clip_price":3300,"koda":81}]}';
                                    	cancelbody = '{"refunds":[{"transaction_id":1437214,"billing_entry_id":"1011","clip_id":"1231","ref":"5caee54bcff133914d5ea5f7547490c4","refunded_clip_price":3300,"koda":81},{"transaction_id":1437215,"billing_entry_id":"1011","clip_id":"1232","ref":"5caee54bcff133914d5ea5f7547490c4","refunded_clip_price":3300,"koda":81},{"transaction_id":1437216,"billing_entry_id":"1011","clip_id":"1233","ref":"5caee54bcff133914d5ea5f7547490c4","refunded_clip_price":3300,"koda":81}],"refunded_koda":244,"refunded_price":9900}';
                                    }
                                    listCanclklip = new List<BlockBusterCancelKlips>();
                                    listCanclklip = BlockbusterParse.parseCancelKlips(cancelbody);
                                    system.debug('cancl cklip list ******* '+listCanclklip);
                                                                           
                                }
                                else
                                {
                                    errMsg = objBBRefundDetails.error_msg;
                                    KlippiPrsnt = false;
                                    errBlock = true;
                                }
                            }       
                        }  
                        if(objBBRefundDetails != null)
                        {
                            IF(objBBRefundDetails.error_msg=='OK')
                            {
                                try
                                {
                                    BlockBusterCallOut.refundMsging(acc, listInvPay[0].Transaction_Date__c, amount, listAllKlipikort,listCanclklip);
                                    BlockBusterInsertUpdate.InsertRefundDetails(objBBRefundDetails);
                                    BlockBusterInsertUpdate.UpdateInvoicePayment(objBBRefundDetails); 
                                }
                                catch(System.CalloutException e)
                                {
                                    errMsg = System.Label.Carrie_Exception;
                                    KlippiPrsnt = false;
                                    errBlock = true;
                                }
                            } 
                        }
                    }
                    else
                    {
                        if(objBBIssueRef.error_code == ArCode.name){
                            errMsg = ArCode.Error_Msgs__c; 
                        } else{
                            errMsg = objBBIssueRef.error_msg;
                        }
                        KlippiPrsnt = false;
                        errBlock = true;
                    }
                }
            }
        }
        else
        {
            errMsg = 'Ingen klip at refundere';
            KlippiPrsnt = false;
            errBlock = true;
        }
        return errMsg;
    }
}